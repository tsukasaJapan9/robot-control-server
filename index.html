<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>webrtc-client-example</title>
</head>

<body>
    <div>
    <input type="text" name="session_id" id="session_id"size="15" value="abc">
    <button id="startSession" onclick="window.startSession()"> Start Session</button>
    </div>

    <br/>

    <div>Video<br/>
    <video id="localVideo" autoplay></video>
    </div>

    <div>
    Logs<br/>
    <div id="div"></div>
    </div>
    <script>

    let pc = new RTCPeerConnection({
        iceServers: [{urls: 'stun:stun.l.google.com:19302'}]
    });

    let log = msg => {
        document.getElementById('div').innerHTML += msg + '<br>'
    };

    async function main() {
        const video = document.getElementById('localVideo');
        stream = await navigator.mediaDevices.getUserMedia({video: true, audio: false})
        video.srcObject = stream 

        for (const track of stream.getTracks()) {
            pc.addTrack(track, stream);
        }

    }

    main();

    // pc.ontrack = (event) => {
    //     var el = document.createElement(event.track.kind);
    //     el.srcObject = event.streams[0];
    //     el.autoplay = true;
    //     el.controls = true;
    //     el.setAttribute('playsinline', '');

    //     document.getElementById('remoteVideos').appendChild(el)
    // };

    // let dataChannel = pc.createDataChannel('foo');
    // dataChannel.onclose = () => console.log('dataChannel has closed');
    // dataChannel.onopen = () => {
    //     console.log('dataChannel has opened');
    //     document.getElementById('sendCommand').disabled = "";
    // };
    // dataChannel.onmessage = e => log(`Message from DataChannel '${dataChannel.label}' payload '${e.data}'`);

    // window.onbeforeunload = () => {
    //     dataChannel.close();
    //     pc.close();
    // };

    // pc.oniceconnectionstatechange = (e) => {
    //     log('ice connection state: ' + pc.iceConnectionState);
    // };

    // pc.onnegotiationneeded = (e) => {
    //     log('negotiation needed: ' + pc.iceConnectionState);
    // };

    // pc.onconnectionstatechange = (e) => {
    //     log('connection state: ' + pc.connectionState);
    // };

    // pc.onicecandidate = event => {
    //     if (event.candidate === null) {
    //         document.getElementById('startSession').disabled = "";
    //     }
    // };

    // // Offer to receive 1 audio, and 2 video tracks
    // pc.addTransceiver('audio', {'direction': 'recvonly'});
    // pc.addTransceiver('video', {'direction': 'recvonly'});
    // pc.addTransceiver('video', {'direction': 'recvonly'});
    // pc.createOffer().then(d => pc.setLocalDescription(d)).catch(log);

    let session_id = document.getElementById("session_id").value;

    window.startSession = () => {
            // サーバが投げてくるofferを受け取る
            fetch(`https://webrtc-sdp-exchanger.appspot.com/sessions/${session_id}/offer`, {
                method: "GET",
                mode: "cors",
                headers: new Headers({"Content-Type": "application/json; charset=utf-8"}),
            }).then((response) => {
                console.log("step2");
                console.log(response);
                if (response.ok) {
                    return response.json();
                }
                return Promise.reject(new Error("invalid response"));
            }).then((json) => {
                console.log("catch session desc");
                try {
                    console.log(json.session_description)
                    pc.setRemoteDescription(new RTCSessionDescription(json.session_description));
                    pc.createAnswer().then((d) => {
                        pc.setLocalDescription(d)
                        fetch(`https://webrtc-sdp-exchanger.appspot.com/sessions/${session_id}`, {
                            method: "POST",
                            mode: "cors",
                            headers: new Headers({"Content-Type": "application/json; charset=utf-8"}),
                            body: JSON.stringify({session_description: d, session_id: session_id}),
                        }).then((response) => {
                            console.log("step3");
                            console.log(response);
                        }).catch(err => console.error);
                    }).catch(log);
                } catch (e) {
                    alert(e);
                }

                document.getElementById('startSession').disabled = "true";
            }).catch(err => console.error);
    };

    // window.sendCommand = () => {
    //     let message = document.getElementById('command').value;
    //     if (message === '') {
    //         return;
    //     }

    //     dataChannel.send(message + '\n');
    //     document.getElementById('command').value = "";
    // };
    </script>
<!-- <div>
<input type="text" name="session_id" id="session_id"size="15" value="abc">
<button id="startSession" onclick="window.startSession()"> Start Session</button>
</div>
 -->
<!-- <div>
Command: <textarea id="command"></textarea> <br/>
<button id="sendCommand" disabled="true" onclick="window.sendCommand()"> Send Command</button>
</div> -->

<!-- <br/>

<div>Video<br/>
<div id="localVideo"></div>
</div>

<div>
Logs<br/>
<div id="div"></div>
</div> -->
<!-- <script>
    document.getElementById('command').addEventListener('keypress', (event) => {
        console.log(event);
        if (event.key === 'Enter') {
            document.getElementById('sendCommand').click();
            return false
        }
    });
</script> -->
</body>
</html>
